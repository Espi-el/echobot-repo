steps:
- id: Build
  name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/echobot-486304/echobot-repo/echobot:$SHORT_SHA', './services/echobot']
- id: Push
  name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/echobot-486304/echobot-repo/echobot:$SHORT_SHA']
- id: Deploy
  name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  entrypoint: gcloud
  args:
  - run
  - deploy
  - echobot
  - --image=us-central1-docker.pkg.dev/echobot-486304/echobot-repo/echobot:$SHORT_SHA
  - --region=us-central1
  - --platform=managed
  - --service-account=echo-deployer@echobot-486304.iam.gserviceaccount.com
  - --set-secrets=SLACK_BOT_TOKEN=projects/echobot-486304/secrets/slack-bot-token:latest,SLACK_SIGNING_SECRET=projects/echobot-486304/secrets/slack-signing-secret:latest
  - --min-instances=1
  - --memory=512Mi
  - --concurrency=80
options:
  logging: CLOUD_LOGGING_ONLY
images:
- 'us-central1-docker.pkg.dev/echobot-486304/echobot-repo/echobot:$SHORT_SHA'
substitutions:
  _REGION: "us-central1"
timeout: '1200s'
